<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Armazenamento | InfraWatch</title>
    <link rel="icon" href="../assets/icon/Logo-InfraWatch.png" />
    <link rel="stylesheet" href="../css/InsigthsMiguel.css">
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@100..800&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/sessao.js"></script>
</head>

<body>

    <header>
        <nav class="header">
            <div class="user_div">
                <div class="img"></div>
                <span class="user_name">André Muller</span>
            </div>

            <ul>
                <a href="./insights.html">Insights</a>
            </ul>
            <ul>
                <a href="./suporte.html">Suporte</a>
            </ul>

            <button class="sair" onclick="limparSessao()">Sair</button>
        </nav>
    </header>

    <main>
        <div class="box">

            <div class="bEsq">
                <div class="kpis">
                    <div class="dSelects">
                        <select name="" id="slctFatorTemp">
                            <option value="" disabled selected>Fator Temporal</option>
                            <option value="">Trimestral</option>
                            <option value="">Semestral</option>
                            <option value="">Anual</option>
                        </select>
                        <select name="" id="slctTipagemAlerta">
                            <option value="" disabled selected>Tipo Alerta</option>
                            <option value="">Moderado</option>
                            <option value="">Crítico</option>
                            <option value="">Geral</option>
                        </select>
                    </div>
                    <div class="dqtdAlert">
                        <div class="card">
                            <p>Total Alertas RAM</p>
                            <span id="spnTotalRam"></span>
                        </div>
                        <div class="card">
                            <p>Total Alertas Disco</p>
                            <span id="spnTotalDis"></span>
                        </div>
                    </div>

                    <div class="dPlus">

                        <div class="cplus">
                            <p>Região com mais alertas</p>
                            <span>none</span>
                        </div>

                        <div class="cplus">
                            <p>Periodo com mais alertas</p>
                            <span id="spnPeriodoMais"></span>
                        </div>

                    </div>

                </div>
                <div class="regiao">
                    <div class="gRegiao">

                    </div>
                </div>
            </div>
            <div class="bDir">
                <div class="gPeriodo">
                    <canvas id="chartPeriodo"></canvas>
                </div>
                <div class="gDisc">
                    <canvas id="chartDisc"></canvas>
                </div>
            </div>
        </div>

    </main>

</body>

</html>

<script>



    const idEmpresa = sessionStorage.ID_EMPRESA;

    fetch(`/alertasMemoria/qtdAlertaD?idEmpresa=${idEmpresa}`, {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
        }
    }).then(function (resposta) {
        console.log("resposta: ", resposta);
        resposta.json().then(json => {
            // console.log(json)

            let nome_mes = []
            let qtd_alerta = []

            for (let i = 0; i < json.length; i++) {
                nome_mes.push(json[i].mes_formatado)
                qtd_alerta.push(json[i].quantidade_alertas)
            }

            const ctxDisc = document.getElementById('chartDisc');

            new Chart(ctxDisc, {
                type: 'bar',
                data: {
                    labels: nome_mes,
                    datasets: [{
                        label: 'Alertas',
                        data: qtd_alerta,
                        backgroundColor: '#2f1b6e',
                        borderRadius: 7
                    }]
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: 'Alertas de Disco',
                            font: {
                                size: 20
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quant. Alertas',
                                font: {
                                    size: 15
                                }
                            }
                        }
                    }
                }
            });

        })
    })
        .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

    let l = ""

    fetch(`/alertasMemoria/qtdAlertaP?idEmpresa=${idEmpresa}`)
        .then(resposta => resposta.json())
        .then(json => {
            // console.log(json);
            l = json.length
            let meses = [];
            let manha = [];
            let tarde = [];
            let noite = [];

            for (let i = 0; i < json.length; i++) {
                console.log(i);
                if (!meses.includes(json[i].mes_formatado)) {
                    console.log(json[[i]]);
                    meses.push(json[i].mes_formatado);
                }
            }

            for (let i = 0; i < meses.length; i++) {
                let qtdManha = 0
                let qtdTarde = 0
                let qtdNoite = 0

                let cManha = 0
                let cTarde = 0
                let cNoite = 0

                for (let j = 0; j < json.length; j++) {
                    if (json[j].mes_formatado === meses[i]) {
                        if (json[j].periodo_dia === 'Manhã') {
                            cManha++
                            qtdManha += json[j].quantidade_alertas
                        };
                        if (json[j].periodo_dia === 'Tarde') {
                            cTarde++
                            qtdTarde += json[j].quantidade_alertas
                        };
                        if (json[j].periodo_dia === 'Noite') {
                            cNoite++
                            qtdNoite += json[j].quantidade_alertas
                        };
                    }
                }

                if (cManha > cTarde && cManha > cNoite) {
                    document.getElementById("spnPeriodoMais").innerHTML = "Manhã"
                } else if (cNoite > cTarde && cNoite > cManha) {
                    document.getElementById("spnPeriodoMais").innerHTML = "Noite"
                } else if (cTarde > cNoite && cTarde > cManha) {
                    document.getElementById("spnPeriodoMais").innerHTML = "Tarde"
                }

                manha.push(qtdManha);
                tarde.push(qtdTarde);
                noite.push(qtdNoite);

            }

            new Chart(document.getElementById('chartPeriodo'), {
                type: 'bar',
                data: {
                    labels: meses,
                    datasets: [
                        {
                            label: 'Manhã',
                            data: manha,
                            backgroundColor: '#e8d8ff',
                            borderRadius: 7
                        },
                        {
                            label: 'Tarde',
                            data: tarde,
                            backgroundColor: '#673dff',
                            borderRadius: 7
                        },
                        {
                            label: 'Noite',
                            data: noite,
                            backgroundColor: '#2510a3',
                            borderRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Alertas de RAM por período'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de alertas'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Meses'
                            }
                        }
                    }
                }
            });
        })



        .catch(erro => console.log('Erro:', erro));



    fetch(`/alertasMemoria/totalRAM?idEmpresa=${idEmpresa}`)
        .then(resposta => resposta.json())
        .then(json => {
            console.log(json);

            let somaAlertas = 0
            for (i = 0; i < json.length; i++) {
                somaAlertas += json[i].totalAlertasRAM
            }

            this.document.getElementById("spnTotalRam").innerHTML = somaAlertas;

        })
        .catch(erro => console.log('Erro:', erro));


    fetch(`/alertasMemoria/totalDisc?idEmpresa=${idEmpresa}`)
        .then(resposta => resposta.json())
        .then(json => {

            let somaAlertas = 0
            for (i = 0; i < json.length; i++) {
                somaAlertas += json[i].totalAlertasDisc
            }

            this.document.getElementById("spnTotalDis").innerHTML = somaAlertas;
        })
        .catch(erro => console.log('Erro:', erro));


</script>