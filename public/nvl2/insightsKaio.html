<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Armazenamento | InfraWatch</title>
    <link rel="icon" href="../assets/icon/Logo-InfraWatch.png" />
    <link rel="stylesheet" href="../css/insightsKaio.css">
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@100..800&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/sessao.js"></script>
</head>

<body onload="carregar(), inicializarPagina()">

    <header>
        <nav class="header">
            <div class="user_div">
                <div class="img"></div>
                <span class="user_name" id="txtUsuario">André Muller</span>
            </div>

            <ul>
                <a href="./insights.html">Insights</a>
            </ul>
            <ul>
                <a href="./suporte.html">Suporte</a>
            </ul>

            <button class="sair" onclick="limparSessao()">Sair</button>
        </nav>
    </header>

    <div class="filtros">

        <span style="font-size: 2rem; font-weight: 600;">Selecione o tempo que deseja analisar os alertas: </span>

        <div id="select-tempo">
            <span style="font-size: 1.5rem; font-weight: 500; margin-left: 1rem;"> <input type="radio"
                    name="escolhaTemporal" value="3" checked>Trimestral</span>
            <span style="font-size: 1.5rem; font-weight: 500; margin-left: 1rem;"> <input type="radio"
                    name="escolhaTemporal" value="5">Semestral</span>
        
        </div>

    </div>


    <div class="kpis-gerais">
        <div class="kpi">
            <span style="font-size: 1.4rem; font-weight: 600;">Componentes com mais alertas críticos</span><br>
            <span id="resultadoKPI1" class="resultadoKPI"></span>
        </div>

        <div class="kpi">
            <span style="font-size: 1.4rem; font-weight: 600;">Marca de CPU que mais gerou alertas</span>
            <span id="resultadoKPI2" class="resultadoKPI"></span>
        </div>

        <div class="kpi">
            <span style="font-size: 1.4rem; font-weight: 600;">Marca de GPU que mais gerou alertas</span>
            <span id="resultadoKPI3" class="resultadoKPI"></span>
        </div>

        <div class="kpi">
            <span style="font-size: 1.4rem; font-weight: 600;">Período com mais alertas</span>
            <span id="resultadoKPI4" class="resultadoKPI" style="margin-top: 5%;"></span>
        </div>
    </div>

    <div class="graficos-insights">

        <div class="grafico-historico">
            <canvas id="grafico-alertas"></canvas>
        </div>
        <div class="grafico-periodo">
            <canvas id="chartPeriodo"></canvas>
        </div>

    </div>

</body>

</html>

<script>

    function inicializarPagina() {
        obterDados();

    }

    var escolhaTempo = document.getElementsByName("escolhaTemporal");
    var escolhaTemporalSelecionado = Array.from(escolhaTempo).find(r => r.checked);
    var escolhaTemporal = escolhaTemporalSelecionado.value

    escolhaTempo.forEach(radio => {
        radio.addEventListener('change', () => {
            escolhaTemporal = radio.value;
            obterDados();
        });
    });

    // Variável para armazenar o resultado por mês, componente e nível
    var resultadoPorMesComponenteNivel = {}


    var resultadoPorMesComponenteNivelPorPeriodo = {}

    // Variável para armazenar o gráfico de alertas
    var GraficoAlertas;

    // Variável para armazenar o gráfico de alertas por período
    var GraficoAlertasPeriodo;


    function obterDados() {


        console.log("Valor de escolhaTemporal test:", escolhaTemporal);

        function separarAlertasCriticosComponentes(dados) {
            // Separando quantidade de Alertas Crticicos e Moderados dos componentes CPU e GPU
            var qtdAlertaCriticoCPU = 0;
            var qtdAlertaCriticoGPU = 0;
            var qtdAlertaModeradoCPU = 0;
            var qtdAlertaModeradoGPU = 0;

            dados.forEach(i => {

                if (i.Componente == 'CPU' && i.nivel == '2') {
                    qtdAlertaCriticoCPU++;
                } else if (i.Componente == 'GPU' && i.nivel == '2') {
                    qtdAlertaCriticoGPU++;
                }

            });

            dados.forEach(i => {

                var mes = i.nomeMes

                if (i.Componente == 'CPU' && i.nivel == '1') {
                    qtdAlertaModeradoCPU++;
                } else if (i.Componente == 'GPU' && i.nivel == '1') {
                    qtdAlertaModeradoGPU++;
                }

            });

            console.log("Quantidade de alertas críticos CPU: " + qtdAlertaCriticoCPU);
            console.log("Quantidade de alertas críticos GPU: " + qtdAlertaCriticoGPU);
            console.log("Quantidade de alertas moderados CPU: " + qtdAlertaModeradoCPU);
            console.log("Quantidade de alertas moderados GPU: " + qtdAlertaModeradoGPU);

            if (qtdAlertaCriticoCPU > qtdAlertaCriticoGPU) {
                document.getElementById("resultadoKPI1").innerHTML = "CPU: " + qtdAlertaCriticoCPU;
            } else {
                document.getElementById("resultadoKPI1").innerHTML = "GPU: " + qtdAlertaCriticoGPU;
            }

        }

        function separarQtdAlertasPorPeriodoComponentes(dados) {
            // Separando quantidade de Alertas por periodo dos componentes CPU e GPU

            var qtdAlertaManha = 0;
            var qtdAlertaTarde = 0;
            var qtdAlertaNoite = 0;

            dados.forEach(i => {
                if (i.periodoDia == 'Manhã') {
                    qtdAlertaManha++;
                } else if (i.periodoDia == 'Tarde') {
                    qtdAlertaTarde++;
                } else if (i.periodoDia == 'Noite') {
                    qtdAlertaNoite++;
                }
            })
            console.log("Quantidade de alertas Manhã: " + qtdAlertaManha);
            console.log("Quantidade de alertas Tarde: " + qtdAlertaTarde);
            console.log("Quantidade de alertas Noite: " + qtdAlertaNoite);

            if (qtdAlertaManha > qtdAlertaTarde && qtdAlertaManha > qtdAlertaNoite) {
                document.getElementById("resultadoKPI4").innerHTML = "Manhã: " + qtdAlertaManha;
            } else if (qtdAlertaTarde > qtdAlertaManha && qtdAlertaTarde > qtdAlertaNoite) {
                document.getElementById("resultadoKPI4").innerHTML = "Tarde: " + qtdAlertaTarde;
            } else {
                document.getElementById("resultadoKPI4").innerHTML = "Noite: " + qtdAlertaNoite;
            }
        }

        function separarAlertasPorMarcaComponentes(dados) {

            // Separando quantidade de Alertas por marca dos componentes CPU e GPU

            var qtdAlertaMarcaIntelCPU = 0;
            var qtdAlertaMarcaAmdCPU = 0;
            var qtdAlertaMarcaNvidiaGPU = 0;
            var qtdAlertaMarcaAmdGPU = 0;
            var qtdAlertaMarcaIntelGPU = 0;

            dados.forEach(i => {
                if (i.Componente == 'CPU' && i.marca == 'Intel') {
                    qtdAlertaMarcaIntelCPU++;
                } else if (i.Componente == 'CPU' && i.marca == 'AMD') {
                    qtdAlertaMarcaAmdCPU++;
                } else if (i.Componente == 'GPU' && i.marca == 'NVIDIA') {
                    qtdAlertaMarcaNvidiaGPU++;
                } else if (i.Componente == 'GPU' && i.marca == 'AMD') {
                    qtdAlertaMarcaAmdGPU++;
                } else if (i.Componente == 'GPU' && i.marca == 'Intel') {
                    qtdAlertaMarcaIntelGPU++;
                }
            })

            console.log("Quantidade de alertas Intel CPU: " + qtdAlertaMarcaIntelCPU);
            console.log("Quantidade de alertas AMD CPU: " + qtdAlertaMarcaAmdCPU);
            console.log("Quantidade de alertas NVIDIA GPU: " + qtdAlertaMarcaNvidiaGPU);
            console.log("Quantidade de alertas AMD GPU: " + qtdAlertaMarcaAmdGPU);
            console.log("Quantidade de alertas Intel GPU: " + qtdAlertaMarcaIntelGPU);

            if (qtdAlertaMarcaIntelCPU > qtdAlertaMarcaAmdCPU) {
                document.getElementById("resultadoKPI2").innerHTML = "Intel: " + qtdAlertaMarcaIntelCPU;
            } else {
                document.getElementById("resultadoKPI2").innerHTML = "AMD: " + qtdAlertaMarcaAmdCPU;
            }

            if (qtdAlertaMarcaNvidiaGPU > qtdAlertaMarcaAmdGPU && qtdAlertaMarcaNvidiaGPU > qtdAlertaMarcaIntelGPU) {
                document.getElementById("resultadoKPI3").innerHTML = "NVIDIA: " + qtdAlertaMarcaNvidiaGPU;
            } else if (qtdAlertaMarcaAmdGPU > qtdAlertaMarcaIntelGPU) {
                document.getElementById("resultadoKPI3").innerHTML = "AMD: " + qtdAlertaMarcaAmdGPU;
            } else {
                document.getElementById("resultadoKPI3").innerHTML = "Intel: " + qtdAlertaMarcaIntelGPU;
            }

        }

        function separarAlertasPorMesEComponenteENivel(dados) {
            // Separando quantidade de Alertas por mes dos componentes CPU e GPU

            dados.forEach(i => {

                if (!resultadoPorMesComponenteNivel[i.nomeMes]) {
                    resultadoPorMesComponenteNivel[i.nomeMes] = {};
                }

                if (!resultadoPorMesComponenteNivel[i.nomeMes][i.Componente]) {
                    resultadoPorMesComponenteNivel[i.nomeMes][i.Componente] = {};
                }


                if (!resultadoPorMesComponenteNivel[i.nomeMes][i.Componente][i.nivel]) {
                    resultadoPorMesComponenteNivel[i.nomeMes][i.Componente][i.nivel] = 0;
                }

                resultadoPorMesComponenteNivel[i.nomeMes][i.Componente][i.nivel]++;
            });
            console.log("Resultado por mês, componente e nível:", resultadoPorMesComponenteNivel);

            // Separando os meses presentes nos dados

            return resultadoPorMesComponenteNivel;
        }

        function separarAlertasPorMesEComponenteNivelPorPeriodo(dados) {
            // Separando quantidade de Alertas por mes dos componentes CPU e GPU

            dados.forEach(i => {

                if (!resultadoPorMesComponenteNivelPorPeriodo[i.nomeMes]) {
                    resultadoPorMesComponenteNivelPorPeriodo[i.nomeMes] = {};
                }
                
                if(!resultadoPorMesComponenteNivelPorPeriodo[i.nomeMes][i.periodoDia]) {
                    resultadoPorMesComponenteNivelPorPeriodo[i.nomeMes][i.periodoDia] = {};
                }
                
                if (!resultadoPorMesComponenteNivelPorPeriodo[i.nomeMes][i.periodoDia][i.Componente]) {
                    resultadoPorMesComponenteNivelPorPeriodo[i.nomeMes][i.periodoDia][i.Componente] = {};
                }


                if (!resultadoPorMesComponenteNivelPorPeriodo[i.nomeMes][i.periodoDia][i.Componente][i.nivel]) {
                    resultadoPorMesComponenteNivelPorPeriodo[i.nomeMes][i.periodoDia][i.Componente][i.nivel] = 0;
                }

                resultadoPorMesComponenteNivelPorPeriodo[i.nomeMes][i.periodoDia][i.Componente][i.nivel]++;
            });
            console.log("Resultado por mês, componente e nível, PERIODO:", resultadoPorMesComponenteNivelPorPeriodo);

            // Separando os meses presentes nos dados

            return resultadoPorMesComponenteNivelPorPeriodo;
        }


        console.log("Escolha temporal:", escolhaTemporal);

        if (escolhaTemporal) {
            fetch("/alertasProcessamento/informacoesAlertas", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    idEmpresa: sessionStorage.ID_EMPRESA,
                    idEscolhaTemporal: escolhaTemporal

                })
            }).then(resposta => resposta.json()).then(dados => {
                console.log("Dados recebidos do periodo:", dados);

                // Reinicializando o objeto para cada nova requisição
                resultadoPorMesComponenteNivel = {}; 

                // Separando quantidade de Alertas Crticicos dos componentes CPU e GPU
                separarAlertasCriticosComponentes(dados);

                // Separando quantidade de Alertas por periodo dos componentes CPU e GPU
                separarQtdAlertasPorPeriodoComponentes(dados);

                // Separando quantidade de Alertas por marca dos componentes CPU e GPU
                separarAlertasPorMarcaComponentes(dados);

                // Separando quantidade de Alertas por mes dos componentes CPU e GPU
                separarAlertasPorMesEComponenteENivel(dados);

                // Separando quantidade de Alertas por mes dos componentes CPU e GPU por periodo
                separarAlertasPorMesEComponenteNivelPorPeriodo(dados);
                
                // Criando o gráfico de alertas por mês

                var meses = Object.keys(resultadoPorMesComponenteNivel);

                var moderado = meses.map(mes => {

                    // Encadeamento, serve para ver se o objeto(mes) existe, se não retorna 0
                    var cpu = resultadoPorMesComponenteNivel[mes]?.CPU?.["1"] || 0;
                    var gpu = resultadoPorMesComponenteNivel[mes]?.GPU?.["1"] || 0;
                    return cpu + gpu; // soma CPU + GPU para nível 1 (Moderado)
                });

                var critico = meses.map(mes => {
                    var cpu = resultadoPorMesComponenteNivel[mes]?.CPU?.["2"] || 0;
                    var gpu = resultadoPorMesComponenteNivel[mes]?.GPU?.["2"] || 0;
                    return cpu + gpu; // soma CPU + GPU para nível 2 (Crítico)
                });

                if(GraficoAlertas) {
                    GraficoAlertas.destroy();
                }

                const ctx = document.getElementById('grafico-alertas').getContext('2d');

                GraficoAlertas = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(resultadoPorMesComponenteNivel),
                        datasets: [
                            {
                                label: 'Moderado',
                                data: moderado,
                                backgroundColor: '#7e22ce', // roxo
                                barThickness: 80
                            },
                            {
                                label: 'Críticos',
                                data: critico,
                                backgroundColor: '#06b6d4', // azul claro
                                barThickness: 80
                            }
                        ]
                    },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: 'Histórico de Alertas GPU e CPU',
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                padding: {
                                    bottom: 20
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                align: 'center',
                                labels: {
                                    font: {
                                        size: 14
                                    }
                                }
                            }
                        },
                        responsive: true,
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Meses do Ano',
                                    font: {
                                        size: 20
                                    }
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Quantidades de alertas',
                                    font: {
                                        size: 20
                                    }
                                }
                            }
                        }
                    }

                });

            }).catch(erro => {
                console.error("Erro na requisição:", erro);
            });

        }

    }




    const ctxPeriodo = document.getElementById('chartPeriodo');

    new Chart(ctxPeriodo, {
        type: 'bar',
        data: {
            labels: ['Dez', 'Jan', 'Fev', 'Mar', 'Abr', 'Mai'],
            datasets: [
                {
                    label: 'Manhã',
                    data: [3, 1, 1, 1, 0, 1],
                    backgroundColor: '#33BFD4'
                },
                {
                    label: 'Tarde',
                    data: [2, 3, 0, 0, 1, 0],
                    backgroundColor: '#F76B3C'
                },
                {
                    label: 'Noite',
                    data: [4, 4, 3, 1, 1, 3],
                    backgroundColor: '#003F4F'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Histórico de Alertas por Periodo GPU e CPU',
                    font: {
                        size: 18,
                        weight: 'bold'
                    }
                },

            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Quantidades de alertas',
                        font: {
                            size: 20
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Ultimos 6 meses',
                        font: {
                            size: 20
                        }
                    }
                }
            }
        }
    });
</script>