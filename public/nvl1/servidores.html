<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servidores | InfraWatch</title>
    <link rel="stylesheet" href="../css/servidores.css">
    <link rel="icon" href="../assets/icon/Logo-InfraWatch.png" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=account_circle" />
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600&display=swap" rel="stylesheet">
    <script src="../js/sessao.js"></script>
    <script src="https://kit.fontawesome.com/d5ea0dfb99.js" crossorigin="anonymous"></script>

    <script src="../js/servidores.js"></script>

</head>

<body onload="getServidores()">
    <header>
        <nav class="navbar">
            <div class="user_div">
                <div class="img"></div>
                <div class="dropdonw_user">
                    <span class="user_name" id="nome_usuario"></span>
                    <div class="dropdonw_content">
                        <span class="sair" onclick="limparSessao()">Sair</span>
                    </div>
                </div>
            </div>

            <ul><a href="./servidores.html">Monitoramento</a></ul>
            <ul><a href="./suporte.html">Suporte</a></ul>

            <div class="notificacao" id="notificacao">
                <div class="sino"></div>
                <span id="countAlerta"></span>
            </div>
        </nav>
    </header>
    <div class="main-content">
        <div class="container">
            <div class="header">
                <div class="alinhamento-esquerda">
                    <button onclick="modalColaborador()" class="btn-add-servidor">Adicionar</button>
                    <input class="input" placeholder="üîç Pesquisar Servidor..." type="search" name=""
                        id="pesquisa-servidor">
                </div>


                <div class="dropdown" onclick="filtro()">
                    <button class="dropdown-status">Filtro ‚ñº</button>
                    <ul class="dropdown-menu">
                        <li><a href="">Total Cr√≠tico: <span id="countAlertaCritico"></span></a></li>
                        <li><a href="">Total Alertas: <span id="countAlertaModerado"></span></a></li>

                    </ul>
                </div>
            </div>

            <div class="modal">
                <div class="content-servidor">
                    <div class="cima">
                        <h3>Cadastro Servidor</h3>
                        <div class="fecharModal"></div>
                    </div>
                    <div class="servidor-modal">
                        <label for="">Nome do servidor:</label>
                        <input type="text" class="inputServidor" id="tagName">
                    </div>
                    <div class="servidor-modal">
                        <label for="">Sistema operacional:</label>
                        <input type="text" class="inputServidor" id="tagName">
                    </div>
                    <!-- <div class="servidor-modal">
                        <label for="">campo:</label>
                        <input type="text" class="inputServidor" id="tagName">
                    </div> -->
                    <button onclick="cadastrar()">Cadastrar</button>
                </div>
            </div> 

            <table id="tabela">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>N√∫cleos</th>
                        <th>Threads</th>
                        <th>Qtd. GPU</th>
                        <th>Temp. GPU</th>
                        <th>Uso GPU</th>
                        <th>Uso CPU</th>
                    </tr>
                </thead>
                <tbody id="corpo-tabela">
                </tbody>
            </table>
        </div>
    </div>
    </div>

</body>

</html>
<script>


    nome_usuario.innerHTML = `${sessionStorage.NOME_USUARIO}   <img src="../assets/icon/arrow_donw.png" alt="" width="20" height="15">`;

    const pesquisa = document.querySelector('.input');
    const btnDropdown = document.querySelector('.dropdown-status');
    const menuDropdown = document.querySelector('.dropdown-menu');

    let servidores;
    let nucleoCpu = 4;
    let threadsCpu = 8;

    document.addEventListener("DOMContentLoaded", function () {
        let idEmpresa = sessionStorage.getItem("ID_EMPRESA");
            
        if (idEmpresa) {
            try {
                fetch(`http://127.0.0.1:8000/monitoramento/listagem/${idEmpresa}`)
                    .then(resposta => {
                        if (!resposta.ok) {
                            console.log("Erro ao buscar os dados.");
                            return;
                        }
                        return resposta.json();
                    })
                    .then(data => {
                        console.log("Dados recebidos do Servidor: ", data);

                        servidores = data;

                        if (Array.isArray(servidores)) {
                            listagemBody()
                        } else {
                            console.log("Servidor n√£o encontrado.")
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao obter os dados: ", error);
                    });
            } catch (error) {
                console.error("Erro ao obter os dados: ", error);
            }
        } else {
            console.log("ID da empresa n√£o encontrado no sessionStorage.");
        }
    });




    function listagemBody() {
        let body = document.getElementById('corpo-tabela');
        body.innerHTML = "";

        servidores.forEach(servidor => {
            const linha = document.createElement('tr');

            let totalNucleo = servidor.qtdCpu * nucleoCpu;
            let totalThreads = servidor.qtdCpu * threadsCpu;

            linha.innerHTML = `
                <td>${servidor.id}</td>
                <td>${servidor.nome}</td>
                <td>${totalNucleo}</td>
                <td>${totalThreads}</td>
                <td>${servidor.qtdGpu}</td>
            `

            body.appendChild(linha);
        });
    }

    document.querySelector('.dropdonw_user').addEventListener('click', function (event) {
        const dropdownContent = this.querySelector('.dropdonw_content');

        if (event.target.closest('.dropdonw_content') || event.target.closest('.sair')) {
            return;
        }

        if (dropdownContent.style.display === 'none' || dropdownContent.style.display === '') {
            dropdownContent.style.display = 'block';
        } else {
            dropdownContent.style.display = 'none';
        }
    });

    document.addEventListener('click', function (event) {
        const dropdown = document.querySelector('.dropdonw_user');
        const dropdownContent = dropdown.querySelector('.dropdonw_content');

        if (!dropdown.contains(event.target)) {
            dropdownContent.style.display = 'none';
        }
    });

    function modalColaborador() {
        const modal = document.querySelector('.modal');
        const modalContent = document.querySelector('.content-servidor');
        const iconFechar = document.querySelector('.fecharModal');
        
        modal.style.display = 'block'
        
        function fecharModal(event) {
            const clicouFora = !modalContent.contains(event.target);
            const clicouNoX = event.target === iconFechar;

            if (clicouFora || clicouNoX) {
                modal.style.display = 'none';
                document.removeEventListener('click', fecharModal);
            }
        }

        setTimeout(() => {
            document.addEventListener('click', fecharModal)
        }, 100);

    }

    pesquisa.oninput = () => {
        const termo = pesquisa.value.toLowerCase();
        const linhas = document.querySelectorAll('tbody tr');

        linhas.forEach(linha => {
            const nome = linha.querySelector('td').textContent.toLowerCase();
            linha.style.display = nome.includes(termo) ? '' : 'none';
        });
    };

    function filtro() {
        const dropdownMenu = document.querySelector('.dropdown-menu');
        dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
    }

    function cadastrar(){
        let nomeServidor = document.getElementById();
        let so = document.getElementById();

        fetch("/servidores/cadastrarServidor", {
            method: "POST",
            headers: {
                "Content-type": "application/json"
            },
            body: JSON.stringify({
                "nomeServidor": nomeServidor,
                "so": so
            })
        })
        .then(function (resposta) {
            resposta.json()
                .then((res) => {
                    console.log(res);
            })
            
            if(resposta.ok){
                // TODO implementar modal de sucesso para o usu√°rio.
            }

        })
        .catch(function (resposta) {
            resposta.json()
                .then((res) => {
                    console.log(res)
                })
        })

    }


</script>