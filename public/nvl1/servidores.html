<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servidores | InfraWatch</title>
    <link rel="stylesheet" href="../css/servidores.css">
    <link rel="icon" href="../assets/icon/Logo-InfraWatch.png" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=account_circle" />
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600&display=swap" rel="stylesheet">
    <script src="../js/sessao.js"></script>
    <script src="https://kit.fontawesome.com/d5ea0dfb99.js" crossorigin="anonymous"></script>

    <script src="../js/servidores.js"></script>

</head>

<body onload="getServidores()">
    <header>
        <nav class="navbar">
            <div class="user_div">
                <div class="img"></div>
                <div class="dropdonw_user">
                    <span class="user_name" id="nome_usuario"></span>
                    <div class="dropdonw_content">
                        <span class="sair" onclick="limparSessao()">Sair</span>
                    </div>
                </div>
            </div>

            <ul><a href="./servidores.html">Monitoramento</a></ul>
            <ul><a href="./suporte.html">Suporte</a></ul>

            <div class="notificacao" id="notificacao">
                <div class="sino"></div>
                <span id="countAlerta">24</span>
                <div class="modalAlertas" style="display: none;">
                    <div class="msg">
                        <span class="msg-text">Alertas</span>
                    </div>
                    <div class="item"></div>
                    <div class="paginacao"></div>
                </div>
            </div>
        </nav>
    </header>
    <div class="main-content">
        <div class="container">
            <div class="header">
                <div class="alinhamento-esquerda">
                    <!-- <button onclick="modalColaborador()" class="btn-add-servidor">Adicionar</button> -->
                    <input class="input" placeholder="üîç Pesquisar Servidor..." type="search" name=""
                        id="pesquisa-servidor">
                </div>


                <div class="dropdown" onclick="filtro()">
                    <button class="dropdown-status">Filtro ‚ñº</button>
                    <ul class="dropdown-menu">
                        <li><a href="" class="componenteArmazenamento">Componentes: HD, RAM</a></li>
                        <li><a href="" class="componenteProcessos">Componentes: GPU, CPU</a></li>
                        <li><a href="">Total Cr√≠tico: <span id="countAlertaCritico"></span></a></li>
                        <li><a href="">Total Alertas: <span id="countAlertaModerado"></span></a></li>

                    </ul>
                </div>
            </div>

<!-- 
            <div class="modal">
                <div class="content-servidor">
                    <div class="cima">
                        <h3>Cadastro Servidor</h3>
                        <div class="fecharModal"></div>
                    </div>
                    <div class="servidor-modal">
                        <label for="">Nome do servidor:</label>
                        <input type="text" class="inputServidor" id="tagName">
                    </div>
                    <div class="servidor-modal">
                        <label for="">Sistema operacional:</label>
                        <input type="text" class="inputServidor" id="tagName">
                    </div>
                    <div class="servidor-modal">
                        <label for="">campo:</label>
                        <input type="text" class="inputServidor" id="tagName">
                    </div>
                    <button onclick="cadastrar()">Cadastrar</button>
                </div>
            </div> -->

            <table id="tabela">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>N√∫cleos</th>
                        <th>Threads</th>
                        <th>Qtd. GPU</th>
                        <th>Temp. GPU</th>
                        <th>Uso GPU</th>
                        <th>Uso CPU</th>
                    </tr>
                </thead>
                <tbody id="corpo-tabela">
                </tbody>
            </table>
        </div>
    </div>
    </div>

</body>

</html>
<script>


    nome_usuario.innerHTML = `${sessionStorage.NOME_USUARIO}   <img src="../assets/icon/arrow_donw.png" alt="" width="20" height="15">`;

    const pesquisa = document.querySelector('.input');
    const btnDropdown = document.querySelector('.dropdown-status');
    const menuDropdown = document.querySelector('.dropdown-menu');
    const filtroItemRamDisco = document.querySelector('.componenteArmazenamento');
    const filtroItemCpuGpu = document.querySelector('.componenteProcessos');
    const corpoTabela = document.getElementById('corpo-tabela'); 
    
    const LIMITE_CRITICO_CPU = 80;    // Exemplo: % de uso CPU cr√≠tico
    const LIMITE_MODERADO_CPU = 60;   // Exemplo: % de uso CPU moderado
    const LIMITE_CRITICO_RAM = 90;    // Exemplo: % de uso RAM cr√≠tico
    const LIMITE_MODERADO_RAM = 75;   // Exemplo: % de uso RAM moderado
    const LIMITE_CRITICO_DISCO = 90;  // Exemplo: % de uso Disco cr√≠tico
    const LIMITE_MODERADO_DISCO = 75;

    let tabelaHeadRow = document.querySelector('#tabela thead tr'); // linha do cabe√ßalho da tabela.
    let estadoComponentesAtual = 'cpu_gpu'; // Estado inicial
    let countAlertaCritico = document.getElementById('countAlertaCritico');
    let countAlertaModerado = document.getElementById('countAlertaModerado');
    let countAlerta = document.getElementById('countAlerta');
    let servidores;
    let geralServidores;
    let nucleoCpu = 4;
    let threadsCpu = 8;

function conversorGB(bytes){
    if(bytes === null || bytes === undefined) return "-";
    let gb = parseFloat(bytes) / (1024 * 1024 * 1024);
    return gb.toFixed(2); 
}

function formatarPorcentagem(valor) {
    if(valor === null || valor === undefined) return "-";
    return parseFloat(valor).toFixed(1);
}

// init
function inicializarMonitoramento() {
    if (sessionStorage.NOME_USUARIO) {
        nome_usuario.innerHTML = `${sessionStorage.NOME_USUARIO}  <img src="../assets/icon/arrow_donw.png" alt="" width="20" height="15">`;
    }
    atualizarVisibilidadeFiltros();
    atualizarDados(); // Primeira carga de dados
    setInterval(atualizarDados, 5000); // Atualiza a cada 5 segundos 
}

function atualizarDados() {
            let idEmpresa = sessionStorage.getItem("ID_EMPRESA");

            if (idEmpresa) {
                try {
                    fetch(`/monitoramento/listagem/${idEmpresa}`)
                        .then(resposta => {
                            if (!resposta.ok) {
                                console.log("Erro ao buscar os dados.");
                                return;
                            }
                            return resposta.json();
                        })
                        .then(data => {
                            console.log("Dados recebidos do Servidor: ", data);

                            servidores = data;

                            if (Array.isArray(servidores)) {
                                renderizarTabelaComCabecalhos(); // Renderiza a tabela com os cabe√ßalhos corretos
                                if (estadoComponentesAtual === 'cpu_gpu') {
                                    listagemBodyCpuGpu(); // Chama a fun√ß√£o espec√≠fica para CPU/GPU
                                } else if (estadoComponentesAtual === 'ram_disco') {
                                    listagemBodyRamDisco(); // Chama a fun√ß√£o espec√≠fica para RAM/Disco
                                }
                            } else {
                                console.log("Servidor n√£o encontrado.")
                            }
                        })
                        .catch(error => {
                            console.error("Erro ao obter os dados: ", error);
                        });
                } catch (error) {
                    console.error("Erro ao obter os dados: ", error);
                }
            } else {
                console.log("ID da empresa n√£o encontrado no sessionStorage.");
            }

            fetch(`/monitoramento/coletar/dados`)
                .then(resposta => {
                    if (!resposta.ok) throw new Error("Resposta n√£o OK");
                    return resposta.json();
                })
                .then(data => {
                    console.log("Dados recebidos do Servidor: ", data);
                    geralServidores = data;
                    if (Array.isArray(servidores) && servidores.length > 0 && geralServidores) {
                        renderizarTabelaComCabecalhos(); // Renderiza a tabela com os cabe√ßalhos corretos
                        if (estadoComponentesAtual === 'cpu_gpu') {
                            listagemBodyCpuGpu(); // Chama a fun√ß√£o espec√≠fica para CPU/GPU
                        } else if (estadoComponentesAtual === 'ram_disco') {
                            listagemBodyRamDisco(); // Chama a fun√ß√£o espec√≠fica para RAM/Disco
                        }
                    } else {
                        corpoTabela.innerHTML = `<tr><td colspan="8" style="text-align:center;">Nenhum servidor encontrado.</td></tr>`;
                    }
                })
                .catch(error => {
                    console.error("Erro ao obter os dados: ", error);
                });
};

    // Fun√ß√£o que carrega o cabe√ßalho da tabela.
function renderizarTabelaComCabecalhos() {
    corpoTabela.innerHTML = ""; // Limpa o corpo da tabela antes de qualquer coisa

    if (estadoComponentesAtual === 'cpu_gpu') {
        tabelaHeadRow.innerHTML = `
            <th>ID</th>
            <th>Nome</th>
            <th>N√∫cleos</th>
            <th>Threads</th>
            <th>Qtd. GPU</th>
            <th>Temp. GPU</th>
            <th>Uso GPU</th>
            <th>Uso CPU</th>
        `;
        if (servidores && geralServidores) listagemBodyCpuGpu();
    } else if (estadoComponentesAtual === 'ram_disco') {
        tabelaHeadRow.innerHTML = `
            <th>ID</th>
            <th>Nome</th>
            <th>RAM Total (GB)</th>
            <th>RAM Uso (GB)</th>
            <th>RAM %</th>
            <th>Disco Total (GB)</th>
            <th>Disco Uso (GB)</th>
            <th>Disco %</th>
        `;
        if (servidores && geralServidores) listagemBodyRamDisco();
    }
    atualizarVisibilidadeFiltros();
}

function listagemBodyCpuGpu() {
    let globalAlertCriticoCount = 0;
    let globalAlertModeradoCount = 0;
    let globalAlertTotalCount = 0;

    if (!Array.isArray(servidores) || !geralServidores) {
         corpoTabela.innerHTML = `<tr><td colspan="8" style="text-align:center;">Dados de CPU/GPU indispon√≠veis.</td></tr>`;
        return;
    }
    if(servidores.length === 0) {
        corpoTabela.innerHTML = `<tr><td colspan="8" style="text-align:center;">Nenhum servidor encontrado.</td></tr>`;
        countAlertaCritico.innerHTML = 0;
        CountAlertaModerado.innerHTML = 0;
        CountAlerta.innerHTML = 0;
        return;
    }

    servidores.forEach(servidor => {
        const linha = document.createElement('tr');
        let totalNucleo = (servidor.qtdCpu || 0) * nucleoCpu;
        let totalThreads = (servidor.qtdCpu || 0) * threadsCpu;

        // Busca a lista de capturas mais recentes para este servidor
        const capturasDoServidor = geralServidores[servidor.id];
        const ultimaCaptura = Array.isArray(capturasDoServidor) && capturasDoServidor.length > 0
            ? capturasDoServidor[capturasDoServidor.length - 1]
            : null;

        // caso n√£o tenha o componente inicia como null.
        let usoCpuData = null;
        let usoGpuData = null; 
        let tempGpuData = null; 

        if (ultimaCaptura && ultimaCaptura.dadosCaptura) {
            usoCpuData = ultimaCaptura.dadosCaptura.find(d => d.componente === "CPU" && d.metrica === "%");
            // Procurar por dados de GPU
            usoGpuData = ultimaCaptura.dadosCaptura.find(d => d.componente === "GPU" && d.metrica === "%");
            tempGpuData = ultimaCaptura.dadosCaptura.find(d => d.componente === "GPU" && d.metrica === "¬∞C");
        }

        const valorUsoCpu = usoCpuData ? parseFloat(usoCpuData.dadoCaptura) : null;

        if (valorUsoCpu !== null) {
            if (valorUsoCpu >= LIMITE_CRITICO_CPU) {
                globalAlertCriticoCount++;
                globalAlertTotalCount++;
            } else if (valorUsoCpu >= LIMITE_MODERADO_CPU) {
                globalAlertModeradoCount++;
                globalAlertTotalCount++;
            }
        }

        linha.innerHTML = `
            <td>${servidor.id || "-"}</td>
            <td>${servidor.nome || "-"}</td>
            <td>${totalNucleo || "-"}</td>
            <td>${totalThreads || "-"}</td>
            <td>${servidor.qtdGpu || 0}</td>
            <td>${tempGpuData ? `${formatarPorcentagem(tempGpuData.dadoCaptura)}¬∞C` : "-"}</td>
            <td>${usoGpuData ? `${formatarPorcentagem(usoGpuData.dadoCaptura)}%` : "-"}</td>
            <td style="color: ${valorUsoCpu !== null ? (valorUsoCpu >= LIMITE_CRITICO_CPU ? 'red' : (valorUsoCpu >= LIMITE_MODERADO_CPU ? 'yellow' : 'green')) : 'inherit'}">
                ${valorUsoCpu !== null ? `${formatarPorcentagem(valorUsoCpu)}%` : "-"}
            </td>
        `;
        corpoTabela.appendChild(linha);
    });

    countAlertaCritico.innerHTML = globalAlertCriticoCount;
    countAlertaModerado.innerHTML = globalAlertModeradoCount;
    countAlerta.innerHTML = globalAlertTotalCount;
}

function listagemBodyRamDisco() {
     if (!Array.isArray(servidores) || !geralServidores) {
        corpoTabela.innerHTML = `<tr><td colspan="8" style="text-align:center;">Dados de RAM/Disco indispon√≠veis.</td></tr>`;
        return;
    }
    if(servidores.length === 0) {
        corpoTabela.innerHTML = `<tr><td colspan="8" style="text-align:center;">Nenhum servidor encontrado.</td></tr>`;
        return;
    }

    servidores.forEach(servidor => {
        const linha = document.createElement('tr');
        const capturasDoServidor = geralServidores[servidor.id];
        const ultimaCaptura = Array.isArray(capturasDoServidor) && capturasDoServidor.length > 0
            ? capturasDoServidor[capturasDoServidor.length - 1]
            : null;

        let ramUsoBytesData = null;
        let ramPercentData = null;
        let hdUsoBytesData = null;
        let hdPercentData = null;

        if (ultimaCaptura && ultimaCaptura.dadosCaptura) {
            ramUsoBytesData = ultimaCaptura.dadosCaptura.find(d => d.componente === "RAM" && d.metrica === "Byte");
            ramPercentData = ultimaCaptura.dadosCaptura.find(d => d.componente === "RAM" && d.metrica === "%");
            hdUsoBytesData = ultimaCaptura.dadosCaptura.find(d => d.componente === "HD" && d.metrica === "Byte");
            hdPercentData = ultimaCaptura.dadosCaptura.find(d => d.componente === "HD" && d.metrica === "%");

            console.log("Dados capturados para o servidor:", servidor.id, {
                ramUsoBytesData,
                ramPercentData,
                hdUsoBytesData,
                hdPercentData
            });
        }

        const ramUsoBytes = ramUsoBytesData ? parseFloat(ramUsoBytesData.dadoCaptura) : null;
        const ramPercent = ramPercentData ? parseFloat(ramPercentData.dadoCaptura) : null;
        const hdUsoBytes = hdUsoBytesData ? parseFloat(hdUsoBytesData.dadoCaptura) : null;
        const hdPercent = hdPercentData ? parseFloat(hdPercentData.dadoCaptura) : null;

        let ramTotalBytesCalculado = null;
        if (ramUsoBytes !== null && ramPercent !== null && ramPercent > 0) {
            ramTotalBytesCalculado = (ramUsoBytes / ramPercent) * 100;
        }

        let hdTotalBytesCalculado = null;
        if (hdUsoBytes !== null && hdPercent !== null && hdPercent > 0) {
            hdTotalBytesCalculado = (hdUsoBytes / hdPercent) * 100;
        }

        linha.innerHTML = `
            <td>${servidor.id || "-"}</td>
            <td>${servidor.nome || "-"}</td>
            <td>${ramTotalBytesCalculado !== null ? conversorGB(ramTotalBytesCalculado) : "-"}</td>
            <td>${ramUsoBytes !== null ? conversorGB(ramUsoBytes) : "-"}</td>
            <td>${ramPercent !== null ? formatarPorcentagem(ramPercent) + '%' : "-"}</td>
            <td>${hdTotalBytesCalculado !== null ? conversorGB(hdTotalBytesCalculado) : "-"}</td>
            <td>${hdUsoBytes !== null ? conversorGB(hdUsoBytes) : "-"}</td>
            <td>${hdPercent !== null ? formatarPorcentagem(hdPercent) + '%' : "-"}</td>
        `;
        corpoTabela.appendChild(linha);
    });
}

filtroItemCpuGpu.addEventListener('click', () => {
    estadoComponentesAtual = 'cpu_gpu';
    renderizarTabelaComCabecalhos();
    atualizarVisibilidadeFiltros();
});

filtroItemRamDisco.addEventListener('click', () => {
    estadoComponentesAtual = 'ram_disco';
    renderizarTabelaComCabecalhos();
    atualizarVisibilidadeFiltros();
});

// --- Fun√ß√µes atualizar o Filtros ---
function atualizarVisibilidadeFiltros() {
    filtroItemCpuGpu.style.display = 'none'
    if (estadoComponentesAtual === 'cpu_gpu') {
        filtroItemCpuGpu.style.display = 'none';
        filtroItemRamDisco.style.display = 'list-item';
    } else if (estadoComponentesAtual === 'ram_disco') {
        console.log("Exibindo RAM e Disco");
        filtroItemRamDisco.style.display = 'none';
        filtroItemCpuGpu.style.display = 'list-item';
    }
}

    function atualizarTabela() {

        if(tabelaAtual && componenteArmazenamento.classlist.contains('ativo')){
            tabelaAtual = tabelaAtual.filter(linha => {
                const usoGpu = linha.querySelector('td:nth-child(7)').textContent;
                const usoCpu = linha.querySelector('td:nth-child(8)').textContent;
                return usoGpu.includes('HD') || usoCpu.includes('RAM');
            });
        } else if(tabelaAtual && componenteProcessos.classlist.contains('ativo')) {
            tabelaAtual = tabelaAtual.filter(linha => {
                const usoGpu = linha.querySelector('td:nth-child(7)').textContent;
                const usoCpu = linha.querySelector('td:nth-child(8)').textContent;
                return usoGpu.includes('GPU') || usoCpu.includes('CPU');
            });
        } else {
            listagemBody();
        }
    } 

    document.querySelector('.dropdonw_user').addEventListener('click', function (event) {
        const dropdownContent = this.querySelector('.dropdonw_content');

        if (event.target.closest('.dropdonw_content') || event.target.closest('.sair')) {
            return;
        }

        if (dropdownContent.style.display === 'none' || dropdownContent.style.display === '') {
            dropdownContent.style.display = 'block';
        } else {
            dropdownContent.style.display = 'none';
        }
    });

    document.addEventListener('click', function (event) {
        const dropdown = document.querySelector('.dropdonw_user');
        const dropdownContent = dropdown.querySelector('.dropdonw_content');

        if (!dropdown.contains(event.target)) {
            dropdownContent.style.display = 'none';
        }
    });

    document.querySelector('.notificacao').addEventListener('click', function () {
        const modalAlertas = document.querySelector('.modalAlertas');
        modalAlertas.style.display = modalAlertas.style.display === 'none' ? 'block' : 'none';
    });

    pesquisa.oninput = () => {
        const termo = pesquisa.value.toLowerCase();
        const linhas = document.querySelectorAll('tbody tr');

        linhas.forEach(linha => {
            const nome = linha.querySelector('td').textContent.toLowerCase();
            linha.style.display = nome.includes(termo) ? '' : 'none';
        });
    };

    function filtro() {
        const dropdownMenu = document.querySelector('.dropdown-menu');
        dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
    }

// Chama a fun√ß√£o de inicializa√ß√£o quando a p√°gina √© carregada
inicializarMonitoramento();    

</script>